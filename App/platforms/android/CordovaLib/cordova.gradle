/*
   Patched Cordova Gradle Script
   Safe version with null checks for matcher.find()
   Compatible with Cordova 11–12 & Gradle 7+
*/

import java.util.regex.Pattern
import io.github.g00fy2.versioncompare.Version

String doEnsureValueExists(filePath, props, key) {
    if (props.get(key) == null) {
        throw new GradleException(filePath + ': Missing key required "' + key + '"')
    }
    return props.get(key)
}

String doGetProjectTarget() {
    def props = new Properties()
    def propertiesFile = 'project.properties'
    if (!(file(propertiesFile).exists())) {
        propertiesFile = '../project.properties'
    }
    file(propertiesFile).withReader { reader ->
        props.load(reader)
    }
    return doEnsureValueExists('project.properties', props, 'target')
}

String getAndroidSdkDir() {
    def rootDir = project.rootDir
    def androidSdkDir = null
    String envVar = System.getenv("ANDROID_SDK_ROOT") ?: System.getenv("ANDROID_HOME")

    def localProperties = new File(rootDir, 'local.properties')
    String systemProperty = System.getProperty("android.home")
    if (envVar != null) {
        androidSdkDir = envVar
    } else if (localProperties.exists()) {
        Properties properties = new Properties()
        localProperties.withInputStream { instr -> properties.load(instr) }
        androidSdkDir = properties.getProperty('sdk.dir')
    }
    if (androidSdkDir == null && systemProperty != null) {
        androidSdkDir = systemProperty
    }
    if (androidSdkDir == null) {
        throw new RuntimeException("Unable to determine Android SDK directory.")
    }
    return androidSdkDir
}

String doFindLatestInstalledBuildTools(String minBuildToolsVersionString) {
    def buildToolsDir = new File(getAndroidSdkDir(), "build-tools")
    if (!buildToolsDir.exists()) {
        throw new RuntimeException("Android build-tools directory not found at: ${buildToolsDir}")
    }

    def versions = buildToolsDir.list()
        ?.collect { new Version(it) }
        ?.findAll { it.isHigherThan('0.0.0') }
        ?.sort()

    if (versions == null || versions.isEmpty()) {
        throw new RuntimeException("No Android build tools found. Please install at least ${minBuildToolsVersionString}.")
    }

    return versions.last().getOriginalString()
}

def doExtractIntFromManifest(name) {
    def manifestFile = file(android.sourceSets.main.manifest.srcFile)
    if (!manifestFile.exists()) {
        println "⚠️  Warning: AndroidManifest.xml not found (${manifestFile})"
        return 0
    }
    def matcher = Pattern.compile(name + "=\"(\\d+)\"").matcher(manifestFile.getText())
    if (!matcher.find()) {
        println "⚠️  Warning: Integer attribute '${name}' not found in AndroidManifest.xml"
        return 0
    }
    return new BigInteger(matcher.group(1))
}

def doExtractStringFromManifest(name) {
    def manifestFile = file(android.sourceSets.main.manifest.srcFile)
    if (!manifestFile.exists()) {
        println "⚠️  Warning: AndroidManifest.xml not found (${manifestFile})"
        return ""
    }
    def matcher = Pattern.compile(name + "=\"(\\S+)\"").matcher(manifestFile.getText())
    if (!matcher.find()) {
        println "⚠️  Warning: String attribute '${name}' not found in AndroidManifest.xml"
        return ""
    }
    return matcher.group(1)
}

def doGetConfigXml() {
    def configFile = file("src/main/res/xml/config.xml")
    if (!configFile.exists()) {
        println "⚠️  Warning: config.xml not found at ${configFile}"
        return new XmlParser(false, false).parseText("<widget></widget>")
    }
    def xml = configFile.getText()
    return new XmlParser(false, false).parseText(xml)
}

def doGetConfigPreference(name, defaultValue) {
    name = name.toLowerCase()
    def root = doGetConfigXml()
    def ret = defaultValue
    root.preference.each {
        def attrName = it.attribute("name")
        if (attrName && attrName.toLowerCase() == name) {
            ret = it.attribute("value")
        }
    }
    return ret
}

def doApplyCordovaConfigCustomization() {
    if (project.hasProperty('cdvBuildToolsVersion')) {
        cordovaConfig.BUILD_TOOLS_VERSION = cdvBuildToolsVersion
    }

    if (!cordovaConfig.BUILD_TOOLS_VERSION) {
        cordovaConfig.BUILD_TOOLS_VERSION = doFindLatestInstalledBuildTools(
            cordovaConfig.MIN_BUILD_TOOLS_VERSION
        )
    }

    def buildToolsVersion = new Version(cordovaConfig.BUILD_TOOLS_VERSION)
    if (buildToolsVersion.isLowerThan(cordovaConfig.MIN_BUILD_TOOLS_VERSION)) {
        println "⚠️  Warning: Using older build tools ${cordovaConfig.BUILD_TOOLS_VERSION}. Expected >= ${cordovaConfig.MIN_BUILD_TOOLS_VERSION}"
    }
}

ext {
    def defaultsFilePath = './cdv-gradle-config-defaults.json'
    def projectConfigFilePath = "$rootDir/cdv-gradle-config.json"
    def targetConfigFilePath = file(projectConfigFilePath).exists() ? projectConfigFilePath : defaultsFilePath

    def jsonFile = new File(targetConfigFilePath)
    cordovaConfig = new groovy.json.JsonSlurper().parseText(jsonFile.text)

    doApplyCordovaConfigCustomization()

    privateHelpers = [:]
    privateHelpers.extractIntFromManifest = { name -> doExtractIntFromManifest(name) }
    privateHelpers.extractStringFromManifest = { name -> doExtractStringFromManifest(name) }
    privateHelpers.applyCordovaConfigCustomization = { -> doApplyCordovaConfigCustomization() }
    cdvHelpers = [:]
    cdvHelpers.getConfigXml = { doGetConfigXml() }
    cdvHelpers.getConfigPreference = { name, defaultValue -> doGetConfigPreference(name, defaultValue) }
    cdvHelpers.verifyCordovaConfigForBuild = {
        if (cordovaConfig == null) {
            throw new GradleException("cordovaConfig is not initialized. Check cdv-gradle-config.json")
        }
        def requiredKeys = ['AGP_VERSION', 'KOTLIN_VERSION', 'MIN_SDK_VERSION', 'COMPILE_SDK_VERSION']
        requiredKeys.each { key ->
            if (!cordovaConfig.containsKey(key) || cordovaConfig.get(key) == null) {
                throw new GradleException("cdv-gradle-config.json missing required key: ${key}")
            }
        }
    }
}

buildscript {
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath 'io.github.g00fy2:versioncompare:1.4.1@jar'
    }
}
