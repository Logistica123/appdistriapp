<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button autoHide="false"></ion-menu-button>
    </ion-buttons>
    <ion-title>Liquidaciones</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="state state--loading" *ngIf="loading">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando tus liquidaciones...</p>
  </div>

  <div class="state state--error" *ngIf="!loading && errorMessage">
    <ion-icon name="warning-outline"></ion-icon>
    <p>{{ errorMessage }}</p>
    <ion-button fill="outline" (click)="loadPersona()">Reintentar</ion-button>
  </div>

  <input
    #fileInput
    type="file"
    accept=".pdf,application/pdf,image/*"
    multiple
    hidden
    (change)="onFilesSelected($event)" />
  <input
    #replaceInput
    type="file"
    accept=".pdf,application/pdf,image/*"
    hidden
    (change)="onReplaceSelected($event)" />

  <ion-card class="filter-card" *ngIf="!loading && !errorMessage && hasPersonaLoaded">
    <ion-card-content>
      <div class="filter-row">
        <ion-item lines="none" class="filter-item">
          <ion-icon slot="start" name="calendar-outline"></ion-icon>
          <ion-label position="stacked">Mes</ion-label>
          <ion-select
            interface="alert"
            [(ngModel)]="selectedMonth"
            (ngModelChange)="onMonthFilterChange($event)"
          >
            <ion-select-option *ngFor="let option of monthOptions" [value]="option.value">
              {{ option.label }}
            </ion-select-option>
          </ion-select>
        </ion-item>
        <ion-item lines="none" class="filter-item">
          <ion-icon slot="start" name="albums-outline"></ion-icon>
          <ion-label position="stacked">Quincena</ion-label>
          <ion-select
            interface="alert"
            [(ngModel)]="selectedFortnight"
            (ngModelChange)="onFortnightFilterChange($event)"
          >
            <ion-select-option *ngFor="let option of fortnightOptions" [value]="option.value">
              {{ option.label }}
            </ion-select-option>
          </ion-select>
        </ion-item>
      </div>
    </ion-card-content>
  </ion-card>

  <ion-list *ngIf="!loading && !errorMessage && cards.length > 0">
    <ng-container *ngFor="let card of cards">
      <ion-item lines="none">
        <ion-icon slot="start" name="document-text-outline"></ion-icon>
        <ion-label>
        <h2>{{ card.main.nombre }}</h2>
        <p *ngIf="getPeriodLabel(card.main) as period">Periodo: {{ period }}</p>
        <p *ngIf="card.main.fechaCarga">Fecha de carga: {{ card.main.fechaCarga | date:'mediumDate' }}</p>
        <p *ngIf="card.main.sizeLabel">Tama침o: {{ card.main.sizeLabel }}</p>
        <p *ngIf="card.main.tipoNombre">Tipo: {{ card.main.tipoNombre }}</p>
        </ion-label>
        <div class="preview" *ngIf="isImage(card.main)" (click)="openPreview(card.main)">
          <img [src]="card.main.absoluteDownloadUrl || card.main.downloadUrl" alt="Vista previa" loading="lazy">
        </div>
        <ion-buttons slot="end">
        <ion-button fill="clear" size="small" (click)="openLiquidacion(card.main)" [disabled]="deletingIds.has(card.main.id)">
          <ion-icon name="download-outline"></ion-icon>
        </ion-button>
        <ion-button fill="clear" size="small" (click)="triggerReplaceLiquidacion(card.main)" [disabled]="quickUploadingIds.has(card.main.id) || deletingIds.has(card.main.id)">
          <ion-icon name="cloud-upload-outline"></ion-icon>
        </ion-button>
        <ion-button fill="clear" color="danger" size="small" (click)="deleteLiquidacion(card.main, card.attachments)" [disabled]="deletingIds.has(card.main.id) || quickUploadingIds.has(card.main.id)">
          <ion-icon name="trash-outline"></ion-icon>
        </ion-button>
        </ion-buttons>
      </ion-item>
      <ion-item lines="none" class="attachment-item" *ngFor="let attachment of card.attachments">
        <ion-icon slot="start" name="document-attach-outline"></ion-icon>
        <ion-label>
          <h3>{{ attachment.nombre }}</h3>
          <p *ngIf="getPeriodLabel(attachment) as attachmentPeriod">Periodo: {{ attachmentPeriod }}</p>
          <p *ngIf="attachment.fechaCarga">Fecha de carga: {{ attachment.fechaCarga | date:'mediumDate' }}</p>
          <p *ngIf="attachment.sizeLabel">Tama침o: {{ attachment.sizeLabel }}</p>
        </ion-label>
        <div class="preview" *ngIf="isImage(attachment)" (click)="openPreview(attachment)">
          <img [src]="attachment.absoluteDownloadUrl || attachment.downloadUrl" alt="Vista previa" loading="lazy">
        </div>
        <ion-buttons slot="end">
          <ion-button fill="clear" size="small" (click)="openLiquidacion(attachment)" [disabled]="deletingIds.has(attachment.id)">
            <ion-icon name="download-outline"></ion-icon>
          </ion-button>
          <ion-button fill="clear" color="danger" size="small" (click)="deleteLiquidacion(attachment)" [disabled]="deletingIds.has(attachment.id)">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-item>
    </ng-container>
  </ion-list>

  <div class="state state--empty" *ngIf="!loading && !errorMessage && cards.length === 0">
    <ion-icon name="document-text-outline"></ion-icon>
    <p>No encontramos liquidaciones cargadas para tu usuario.</p>
    <p class="state__hint">Cuando suban nuevas liquidaciones vas a verlas ac치.</p>
  </div>

  <div class="preview-overlay" *ngIf="isPreviewOpen">
    <div class="preview-overlay__backdrop" (click)="closePreview()"></div>
    <div class="preview-modal__content" *ngIf="previewDoc">
      <div class="preview-modal__header">
        <h3>{{ previewDoc.nombre }}</h3>
        <ion-button fill="clear" size="small" (click)="closePreview()">
          <ion-icon name="close-outline"></ion-icon>
        </ion-button>
      </div>
      <div class="preview-modal__body">
        <img [src]="previewDoc.absoluteDownloadUrl || previewDoc.downloadUrl" [alt]="previewDoc.nombre">
      </div>
      <div class="preview-modal__actions">
        <ion-button fill="solid" size="small" (click)="openLiquidacion(previewDoc)">Abrir en nueva pesta침a</ion-button>
        <ion-button fill="clear" size="small" (click)="closePreview()">Cerrar</ion-button>
      </div>
    </div>
  </div>
</ion-content>
